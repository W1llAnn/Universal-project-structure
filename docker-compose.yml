# –°–ï–†–í–ò–°–´ (services)
# –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
services:
  # API-—Å–µ—Ä–≤–∏—Å (FastAPI)
  app:
    build: .                                # –°–æ–±–∏—Ä–∞–µ—Ç –æ–±—Ä–∞–∑ –∏–∑ Dockerfile –≤ –∫–æ—Ä–Ω–µ
    container_name: api       # –£–¥–æ–±–Ω–æ–µ –∏–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–≤–∏–¥–Ω–æ –≤ `docker ps`)
    # –ü–æ—Ä—Ç—ã: –≤–Ω–µ—à–Ω–∏–π:–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π
    # –í–∞–∂–Ω–æ: –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–æ—Ä—Ç –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Ç–µ–º, —á—Ç–æ —Å–ª—É—à–∞–µ—Ç uvicorn
    ports:
      - "${API_PORT}:20142"                # –ù–∞–ø—Ä–∏–º–µ—Ä: 8000:20142 ‚Üí localhost:8000 = API
    # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    # –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é –∏–ª–∏ —á–µ—Ä–µ–∑ .env
    environment:
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}
      OPENAI_API_KEY: ${OPENAI_API_KEY}    # –∏–ª–∏ –¥—Ä—É–≥–æ–π LLM-–∫–ª—é—á
      LLM_MODEL: ${LLM_MODEL}
      DEBUG: ${DEBUG}
    # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: –∂–¥—ë–º, –ø–æ–∫–∞ –ë–î –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è
    depends_on:
      - db
    # –ú–æ–Ω—Ç–∏—Ä—É–µ–º —Ç–æ–º–∞
    # .:/app ‚Äî –∫–æ–¥ –ø—Ä–æ–µ–∫—Ç–∞ (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, –Ω–µ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞!)
    # /tmp ‚Äî –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤)
    # .env:/app/.env ‚Äî –∫–æ–ø–∏—Ä—É–µ–º .env –≤–Ω—É—Ç—Ä—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (—á—Ç–æ–±—ã –±—ã–ª –¥–æ—Å—Ç—É–ø–µ–Ω)
    volumes:
      - .:/app                              # –ì–æ—Ä—è—á–∞—è –∑–∞–º–µ–Ω–∞ –∫–æ–¥–∞ (hot reload)
      - /tmp:/tmp                           # –î–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
      - .env:/app/.env                      # –ü—Ä–æ–±—Ä–æ—Å .env (–±–µ–∑–æ–ø–∞—Å–Ω–æ, –µ—Å–ª–∏ –Ω–µ –∫–æ–º–º–∏—Ç–∏—Ç—Å—è)
    # –ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞
    # --host 0.0.0.0 ‚Äî —á—Ç–æ–±—ã –±—ã–ª –¥–æ—Å—Ç—É–ø –∏–∑–≤–Ω–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    # --port 20142 ‚Äî —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–æ—Ä—Ç—É –≤ `ports`
    command: uvicorn main:app --host 0.0.0.0 --port 20142
    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
    restart: unless-stopped                 # –ê–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫, –∫—Ä–æ–º–µ —Ä—É—á–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
    # –°–µ—Ç—å
    networks:
      - vllm_network

  # Gradio –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
  gradio:
    build: .                                # –¢–æ—Ç –∂–µ –æ–±—Ä–∞–∑ ‚Äî –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å —Ä–∞–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
    container_name: gradio
    ports:
      - "${GRADIO_PORT}:20141"              # –ù–∞–ø—Ä–∏–º–µ—Ä: 7860:20141 ‚Üí localhost:7860
    volumes:
      - .:/app
      - /tmp:/tmp
      - .env:/app/.env
    # –ó–∞–ø—É—Å–∫–∞–µ–º Gradio-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    command: python gradio_app/gradio_app.py
    restart: unless-stopped
    networks:
      - vllm_network

  # PostgreSQL –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
  db:
    image: postgres:15                      # –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑ PostgreSQL 15
    container_name: auto_reviewer-db
    # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î
    environment:
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      PGPORT: ${DB_PORT}                    # –ü–æ—Ä—Ç, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è PostgreSQL –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    # –¢–æ–º –¥–∞–Ω–Ω—ã—Ö ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ë–î –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏
    volumes:
      - postgres_data:/var/lib/postgresql/data  # –ü—É—Ç—å –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
      - .env:/app/.env                      # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø—Ä–æ–±—Ä–æ—Å .env (—Ä–µ–¥–∫–æ –Ω—É–∂–Ω–æ)
    # –ü–æ—Ä—Ç—ã: –≤–Ω–µ—à–Ω–∏–π:–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π
    # –ù–∞–ø—Ä–∏–º–µ—Ä: 5433:5432 ‚Üí –≤–Ω–µ—à–Ω–∏–π –ø–æ—Ä—Ç 5433 ‚Üí –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ 5432
    ports:
      - "${DB_PORT_EXTERNAL}:${DB_PORT}"    # DB_PORT_EXTERNAL=5433, DB_PORT=5432
    restart: unless-stopped
    networks:
      - vllm_network
    # –ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞ PostgreSQL –Ω–∞ –Ω—É–∂–Ω–æ–º –ø–æ—Ä—Ç—É
    command: postgres -p ${DB_PORT}

# –°–ï–¢–ò (networks)
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–Ω–µ—à–Ω—è—è —Å–µ—Ç—å, —á—Ç–æ–±—ã —Å–æ–µ–¥–∏–Ω—è—Ç—å—Å—è —Å –¥—Ä—É–≥–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, vLLM)
networks:
  vllm_network:
    external: true  # –°–µ—Ç—å —Å–æ–∑–¥–∞—ë—Ç—Å—è –≤–Ω–µ —ç—Ç–æ–≥–æ compose (—á–µ—Ä–µ–∑ `docker network create vllm_network`)

# –¢–û–ú–´ (volumes)
# –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
volumes:
  postgres_data:  # –ò–º—è —Ç–æ–º–∞ ‚Äî –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω Docker'–æ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    driver: local


# ========================================
# üìù –ü–û–Ø–°–ù–ï–ù–ò–Ø –ö –ü–ê–†–ê–ú–ï–¢–†–ê–ú
#
# build: .
#   ‚Äî –°–æ–±–∏—Ä–∞–µ—Ç –æ–±—Ä–∞–∑ –∏–∑ Dockerfile –≤ —Ç–µ–∫—É—â–µ–π –ø–∞–ø–∫–µ.
#
# container_name
#   ‚Äî –£–¥–æ–±–Ω–æ–µ –∏–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. –ü–æ–ª–µ–∑–Ω–æ –ø—Ä–∏ –æ—Ç–ª–∞–¥–∫–µ (`docker logs api`).
#
# ports
#   ‚Äî –§–æ—Ä–º–∞—Ç: "–≤–Ω–µ—à–Ω–∏–π_–ø–æ—Ä—Ç:–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π_–ø–æ—Ä—Ç"
#     –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ‚Äî —Ç–æ—Ç, —á—Ç–æ —Å–ª—É—à–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ (uvicorn/gradio/postgres).
#
# environment
#   ‚Äî –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ.
#     –õ—É—á—à–µ –±—Ä–∞—Ç—å –∏–∑ .env, –∞ –Ω–µ –ø–∏—Å–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é.
#
# depends_on
#   ‚Äî –ì–æ–≤–æ—Ä–∏—Ç Docker: "–∑–∞–ø—É—Å—Ç–∏ db —Ä–∞–Ω—å—à–µ, —á–µ–º app".
#     –ù–æ –ù–ï –∂–¥—ë—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ë–î (—Ç–æ–ª—å–∫–æ –∑–∞–ø—É—Å–∫–∞). –î–ª—è –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ wait ‚Äî –Ω—É–∂–µ–Ω `wait-for-it`.
#
# volumes
#   - .:/app ‚Äî –º–æ–Ω—Ç–∏—Ä—É–µ—Ç –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç –≤–Ω—É—Ç—Ä—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏).
#   - –ò–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–π —Ç–æ–º (postgres_data) ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –ë–î.
#   - .env:/app/.env ‚Äî –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Ñ–∞–π–ª —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏ –≤–Ω—É—Ç—Ä—å.
#
# command
#   ‚Äî –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç CMD –∏–∑ Dockerfile. –£–¥–æ–±–Ω–æ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –∏–∑ –æ–¥–Ω–æ–≥–æ –æ–±—Ä–∞–∑–∞.
#
# restart: unless-stopped
#   ‚Äî –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏, –Ω–æ –Ω–µ –ø–æ—Å–ª–µ `docker stop`.
#
# networks
#   ‚Äî –ü–æ–¥–∫–ª—é—á–∞–µ—Ç –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∫ –æ–¥–Ω–æ–π —Å–µ—Ç–∏ ‚Äî –æ–Ω–∏ –º–æ–≥—É—Ç –æ–±—â–∞—Ç—å—Å—è –ø–æ –∏–º–µ–Ω–∏ (app ‚Üí db).